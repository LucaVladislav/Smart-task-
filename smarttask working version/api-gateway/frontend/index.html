<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SmartTask – Demo microservicii</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <style>
        body {
            background: #f5f5f5;
        }
        .card {
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        .token-badge {
            font-size: 0.75rem;
            word-break: break-all;
        }
        .task-item {
            border-bottom: 1px solid #eee;
            padding: 0.4rem 0;
        }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="mb-4 text-center">SmartTask – Demo microservicii</h1>

    <!-- ========== VIEW 1: AUTH (REGISTER + LOGIN) ========== -->
    <div id="authView">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        Autentificare
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="loginEmail" class="form-control" value="test@example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parolă</label>
                            <input type="password" id="loginPassword" class="form-control" value="parola123" />
                        </div>
                        <button id="btnLogin" class="btn btn-primary w-100 mb-2">
                            Login
                        </button>
                        <div id="loginMessage" class="small mt-2"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        Înregistrare utilizator nou
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="regEmail" class="form-control" placeholder="user@example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parolă</label>
                            <input type="password" id="regPassword" class="form-control" placeholder="parola123" />
                        </div>
                        <button id="btnRegister" class="btn btn-secondary w-100">
                            Register
                        </button>
                        <div id="regMessage" class="small mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== VIEW 2: APP (TASKS) – doar după login ========== -->
    <div id="appView" class="d-none">
        <div class="row justify-content-center mb-3">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">Bine ai venit, <span id="userEmailSpan"></span></div>
                            <div class="small text-muted">
                                Ai acces la task-urile tale personale.
                            </div>
                        </div>
                        <button id="btnLogout" class="btn btn-outline-danger btn-sm">
                            Logout
                        </button>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        Creează un task nou
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">Titlu</label>
                            <input type="text" id="taskTitle" class="form-control" placeholder="Ex: Scrie raportul" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Descriere</label>
                            <textarea id="taskDescription" class="form-control"
                                      rows="2" placeholder="Detalii despre task"></textarea>
                        </div>
                        <button id="btnAddTask" class="btn btn-success w-100 mb-2">
                            Adaugă task
                        </button>
                        <div id="taskMessage" class="small mb-2"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <span>Task-urile mele</span>
                        <button id="btnLoadTasks" class="btn btn-sm btn-outline-secondary">
                            Reîncarcă
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="taskList" class="small"></div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-light">
                        Token JWT curent (demo)
                    </div>
                    <div class="card-body">
                        <div id="tokenBox" class="token-badge bg-light border rounded p-2 small">
                            (neautentificat)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p class="mt-4 text-center text-muted small">
        Backend: API Gateway (FastAPI) + User Service + Task Service + PostgreSQL (Docker).
    </p>
</div>

<script>
    const API_BASE = "http://localhost:8000";
    let accessToken = null;
    let currentUserEmail = null;

    function setMessage(el, text, type = "info") {
        el.textContent = text;
        el.className = "small mt-2 text-" + type;
    }

    function showAuthView() {
        document.getElementById("authView").classList.remove("d-none");
        document.getElementById("appView").classList.add("d-none");
    }

    function showAppView() {
        document.getElementById("authView").classList.add("d-none");
        document.getElementById("appView").classList.remove("d-none");
        document.getElementById("userEmailSpan").textContent = currentUserEmail || "";
        updateTokenBox();
    }

    function updateTokenBox() {
        const tokenBox = document.getElementById("tokenBox");
        if (!accessToken) {
            tokenBox.textContent = "(neautentificat)";
        } else {
            tokenBox.textContent = accessToken;
        }
    }

    async function apiRequest(path, method = "GET", body = null, requireAuth = false) {
        const headers = { "Content-Type": "application/json" };
        if (requireAuth && accessToken) {
            headers["Authorization"] = "Bearer " + accessToken;
        }

        const resp = await fetch(API_BASE + path, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null,
        });

        const text = await resp.text();
        let data = null;
        try {
            data = text ? JSON.parse(text) : null;
        } catch {
            data = text;
        }

        if (!resp.ok) {
            const message = data && data.detail ? data.detail : ("Eroare " + resp.status);
            throw new Error(message);
        }
        return data;
    }

    // ========== REGISTER ==========
    document.getElementById("btnRegister").addEventListener("click", async () => {
        const email = document.getElementById("regEmail").value.trim();
        const password = document.getElementById("regPassword").value.trim();
        const msgEl = document.getElementById("regMessage");

        if (!email || !password) {
            setMessage(msgEl, "Completează email și parolă.", "danger");
            return;
        }

        try {
            const data = await apiRequest("/auth/register", "POST", { email, password });
            setMessage(msgEl, "Utilizator creat cu ID " + data.id, "success");
            // pentru confort, completăm automat la login
            document.getElementById("loginEmail").value = email;
            document.getElementById("loginPassword").value = password;
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    // ========== LOGIN ==========
    document.getElementById("btnLogin").addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const msgEl = document.getElementById("loginMessage");

        if (!email || !password) {
            setMessage(msgEl, "Completează email și parolă.", "danger");
            return;
        }

        try {
            const data = await apiRequest("/auth/login", "POST", { email, password });
            accessToken = data.access_token;
            currentUserEmail = email;
            setMessage(msgEl, "Autentificat cu succes!", "success");
            showAppView();
            await loadTasks(); // încărcăm imediat task-urile
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    // ========== LOGOUT ==========
    document.getElementById("btnLogout").addEventListener("click", () => {
        accessToken = null;
        currentUserEmail = null;
        updateTokenBox();
        showAuthView();
    });

    // ========== ADD TASK ==========
    document.getElementById("btnAddTask").addEventListener("click", async () => {
        const title = document.getElementById("taskTitle").value.trim();
        const description = document.getElementById("taskDescription").value.trim();
        const msgEl = document.getElementById("taskMessage");

        if (!accessToken) {
            setMessage(msgEl, "Trebuie să fii logat pentru a crea task-uri.", "danger");
            return;
        }
        if (!title) {
            setMessage(msgEl, "Titlul este obligatoriu.", "danger");
            return;
        }

        try {
            const data = await apiRequest(
                "/tasks",
                "POST",
                { title, description },
                true
            );
            setMessage(msgEl, "Task creat cu ID " + data.id, "success");
            document.getElementById("taskTitle").value = "";
            document.getElementById("taskDescription").value = "";
            await loadTasks();
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    // ========== LOAD TASKS ==========
    async function loadTasks() {
        const msgEl = document.getElementById("taskMessage");
        const listEl = document.getElementById("taskList");

        if (!accessToken) {
            setMessage(msgEl, "Trebuie să fii logat pentru a vedea task-urile.", "danger");
            return;
        }

        try {
            const data = await apiRequest("/tasks", "GET", null, true);
            listEl.innerHTML = "";
            if (!data || data.length === 0) {
                listEl.textContent = "Nu există task-uri.";
            } else {
                data.forEach((t) => {
                    const div = document.createElement("div");
                    div.className = "task-item";
                    div.innerHTML = `<strong>${t.title}</strong><br/><span class="text-muted">${t.description || ""}</span>`;
                    listEl.appendChild(div);
                });
            }
            setMessage(msgEl, "Task-uri încărcate.", "success");
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    }

    document.getElementById("btnLoadTasks").addEventListener("click", loadTasks);

    // La început afișăm ecranul de autentificare
    showAuthView();
</script>
</body>
</html>
