<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SmartTask – Demo microservicii</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { background: #f5f5f5; }
        .card { box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .token-badge { font-size: 0.75rem; word-break: break-all; }
        .task-item {
            border-bottom: 1px solid #eee;
            padding: 0.8rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-item:last-child { border-bottom: none; }
        .task-actions button { font-size: 0.85rem; }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="mb-4 text-center">SmartTask – Demo microservicii</h1>

    <!-- ========== VIEW 1: AUTH ========== -->
    <div id="authView">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">Autentificare</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="loginEmail" class="form-control" value="test@example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parolă</label>
                            <input type="password" id="loginPassword" class="form-control" value="parola123" />
                        </div>
                        <button id="btnLogin" class="btn btn-primary w-100 mb-2">Login</button>
                        <div id="loginMessage" class="small mt-2"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-secondary text-white">Înregistrare utilizator nou</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="regEmail" class="form-control" placeholder="user@example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parolă</label>
                            <input type="password" id="regPassword" class="form-control" placeholder="parola123" />
                        </div>
                        <button id="btnRegister" class="btn btn-secondary w-100">Register</button>
                        <div id="regMessage" class="small mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== VIEW 2: APP (TASKS) ========== -->
    <div id="appView" class="d-none">
        <div class="row justify-content-center mb-3">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">Bine ai venit, <span id="userEmailSpan"></span></div>
                            <div class="small text-muted">Ai acces la task-urile tale personale.</div>
                        </div>
                        <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
                    </div>
                </div>

                <!-- Formular creare / editare task -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white" id="taskFormHeader">
                        Creează un task nou
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">Titlu</label>
                            <input type="text" id="taskTitle" class="form-control" placeholder="Ex: Scrie raportul" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Descriere</label>
                            <textarea id="taskDescription" class="form-control" rows="2" placeholder="Detalii despre task"></textarea>
                        </div>
                        <button id="btnAddTask" class="btn btn-success w-100 mb-2">
                            Adaugă task
                        </button>
                        <div id="taskMessage" class="small mb-2"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <span>Task-urile mele</span>
                        <button id="btnLoadTasks" class="btn btn-sm btn-outline-secondary">Reîncarcă</button>
                    </div>
                    <div class="card-body">
                        <div id="taskList" class="small"></div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-light">Token JWT curent (demo)</div>
                    <div class="card-body">
                        <div id="tokenBox" class="token-badge bg-light border rounded p-2 small">
                            (neautentificat)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <p class="mt-4 text-center text-muted small">
        Backend: API Gateway (FastAPI) + User Service + Task Service + PostgreSQL (Docker).
    </p>
</div>

<script>
    const API_BASE = ""; // important: acum mergem relativ → proxy-ul din gateway face tot!
    let accessToken = null;
    let currentUserEmail = null;
    let editingTaskId = null; // <--- NOU: ține minte ce task edităm

    function setMessage(el, text, type = "info") {
        el.textContent = text;
        el.className = "small mt-2 text-" + type;
    }

    function showAuthView() {
        document.getElementById("authView").classList.remove("d-none");
        document.getElementById("appView").classList.add("d-none");
    }

    function showAppView() {
        document.getElementById("authView").classList.add("d-none");
        document.getElementById("appView").classList.remove("d-none");
        document.getElementById("userEmailSpan").textContent = currentUserEmail || "";
        updateTokenBox();
    }

    function updateTokenBox() {
        const tokenBox = document.getElementById("tokenBox");
        tokenBox.textContent = accessToken ? accessToken : "(neautentificat)";
    }

    async function apiRequest(path, method = "GET", body = null, requireAuth = false) {
        const headers = { "Content-Type": "application/json" };
        if (requireAuth && accessToken) {
            headers["Authorization"] = "Bearer " + accessToken;
        }

        const resp = await fetch(API_BASE + path, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null,
        });

        const text = await resp.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch { data = text; }

        if (!resp.ok) {
            const message = data && data.detail ? data.detail : ("Eroare " + resp.status);
            throw new Error(message);
        }
        return data;
    }

    // ========== REGISTER & LOGIN (neschimbate) ==========
    document.getElementById("btnRegister").addEventListener("click", async () => {
        const email = document.getElementById("regEmail").value.trim();
        const password = document.getElementById("regPassword").value.trim();
        const msgEl = document.getElementById("regMessage");

        if (!email || !password) return setMessage(msgEl, "Completează toate câmpurile.", "danger");

        try {
            const data = await apiRequest("/auth/register", "POST", { email, password });
            setMessage(msgEl, "Cont creat cu succes!", "success");
            document.getElementById("loginEmail").value = email;
            document.getElementById("loginPassword").value = password;
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    document.getElementById("btnLogin").addEventListener("click", async () => {
        const email = document.getElementById("loginEmail").value.trim();
        const password = document.getElementById("loginPassword").value.trim();
        const msgEl = document.getElementById("loginMessage");

        try {
            const data = await apiRequest("/auth/login", "POST", { email, password });
            accessToken = data.access_token;
            currentUserEmail = email;
            editingTaskId = null;
            showAppView();
            await loadTasks();
            setMessage(msgEl, "Login reușit!", "success");
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    document.getElementById("btnLogout").addEventListener("click", () => {
        accessToken = null;
        currentUserEmail = null;
        editingTaskId = null;
        resetTaskForm();
        updateTokenBox();
        showAuthView();
    });

    // ========== FORMULAR TASK (create + update) ==========
    function resetTaskForm() {
        document.getElementById("taskTitle").value = "";
        document.getElementById("taskDescription").value = "";
        document.getElementById("btnAddTask").textContent = "Adaugă task";
        document.getElementById("taskFormHeader").textContent = "Creează un task nou";
        editingTaskId = null;
    }

    document.getElementById("btnAddTask").addEventListener("click", async () => {
        const title = document.getElementById("taskTitle").value.trim();
        const description = document.getElementById("taskDescription").value.trim();
        const msgEl = document.getElementById("taskMessage");

        if (!title) {
            setMessage(msgEl, "Titlul este obligatoriu!", "danger");
            return;
        }

        try {
            if (editingTaskId === null) {
                // CREATE
                await apiRequest("/tasks", "POST", { title, description }, true);
                setMessage(msgEl, "Task creat cu succes!", "success");
            } else {
                // UPDATE
                await apiRequest(`/tasks/${editingTaskId}`, "PUT", { title, description }, true);
                setMessage(msgEl, "Task actualizat!", "success");
            }

            resetTaskForm();
            await loadTasks();
        } catch (err) {
            setMessage(msgEl, err.message, "danger");
        }
    });

    // ========== EDIT TASK ==========
    function startEdit(task) {
        editingTaskId = task.id;
        document.getElementById("taskTitle").value = task.title || "";
        document.getElementById("taskDescription").value = task.description || "";
        document.getElementById("btnAddTask").textContent = "Salvează modificările";
        document.getElementById("taskFormHeader").textContent = "Editează task";
        document.getElementById("taskMessage").textContent = "";
        // scroll sus la formular
        document.querySelector("#appView .card.mb-3").scrollIntoView({ behavior: "smooth" });
    }

    // ========== DELETE TASK ==========
    async function deleteTask(id) {
        if (!confirm("Sigur vrei să ștergi acest task?")) return;

        try {
            await apiRequest(`/tasks/${id}`, "DELETE", null, true);
            if (editingTaskId === id) resetTaskForm();
            await loadTasks();
        } catch (err) {
            alert("Eroare la ștergere: " + err.message);
        }
    }

    // ========== LOAD TASKS ==========
    async function loadTasks() {
        const listEl = document.getElementById("taskList");
        listEl.innerHTML = "<div class='text-muted'>Se încarcă...</div>";

        try {
            const data = await apiRequest("/tasks", "GET", null, true);
            listEl.innerHTML = "";

            if (!data || data.length === 0) {
                listEl.innerHTML = "<div class='text-muted'>Nu ai niciun task încă.</div>";
                return;
            }

            data.forEach(t => {
                const div = document.createElement("div");
                div.className = "task-item";
                div.innerHTML = `
                    <div>
                        <strong>${escapeHtml(t.title)}</strong><br/>
                        <span class="text-muted">${escapeHtml(t.description || "")}</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-sm btn-outline-primary me-2 btn-edit">Editează</button>
                        <button class="btn btn-sm btn-outline-danger btn-delete">Șterge</button>
                    </div>
                `;
                div.querySelector(".btn-edit").onclick = () => startEdit(t);
                div.querySelector(".btn-delete").onclick = () => deleteTask(t.id);
                listEl.appendChild(div);
            });
        } catch (err) {
            listEl.innerHTML = `<div class="text-danger">Eroare: ${err.message}</div>`;
        }
    }

    // protecție XSS simplă
    function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    document.getElementById("btnLoadTasks").addEventListener("click", loadTasks);
    showAuthView();
</script>
</body>
</html>